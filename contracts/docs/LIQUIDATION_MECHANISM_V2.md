# Liquidation Mechanism v2 - Dutch Auction

**Status:** Implemented
**Affected Contract:** `LiquidationManager.sol`

## 1. Change Summary

This document describes the transition of the liquidation mechanism from an **English Auction** to a **Dutch Auction**. The change was motivated by the analysis of reference protocols like MakerDAO, aiming for greater capital efficiency, lower gas costs for participants, and a faster, more deterministic liquidation process.

## 2. The Old Model (English Auction)

- **Flow:** Multiple participants placed increasing bids (`bid`) during a fixed period (`AUCTION_DURATION`).
- **Problems:**
    - **Gas Inefficiency:** Required multiple blockchain transactions to compete.
    - **Slowness:** The auction needed to run for a long period to ensure price discovery.
    - **User Complexity:** The winner had to return to execute a separate `claim()` function.

## 3. The New Model (Dutch Auction)

Inspired by MakerDAO's `Clipper.sol` contract, the new model inverts the price discovery process.

### 3.1. Auction Flow

1.  **Start (`startAuction`):** When a `Vault` is liquidated, an auction is started. The collateral price starts **high** â€“ a multiplier (e.g., 150%) above the current oracle price.
2.  **Price Decay:** The collateral price **decreases linearly** over time. It does not wait for bids; the price simply drops with each block.
3.  **Purchase (`buy`):** A participant (buyer) monitors the auction off-chain. When the price reaches a level they consider fair or profitable, they call the `buy()` function **a single time**.

### 3.2. The `buy()` Function

This function is the heart of the new mechanism and replaces both `bid()` and `claim()`. It is **atomic**.

- **Parameters:** The buyer specifies the auction ID and the amount of collateral they want to buy.
- **Execution:**
    1.  The contract calculates the `currentPrice` based on the time elapsed since the auction's start.
    2.  It calculates the `debtToPay` (cost in SCC-USD) for the desired amount of collateral.
    3.  **Atomicity:** In the same transaction, the contract:
        - Transfers the `debtToPay` (SCC-USD) from the buyer's wallet.
        - Transfers the purchased collateral to the buyer's wallet.
    4.  The auction's state is updated, deducting the amount of collateral sold and the debt covered.

### 3.3. Advantages of the New Model

- **Capital and Gas Efficiency:** A buyer executes only **one transaction** to secure their purchase.
- **Speed:** Liquidations can be completed much more quickly, as soon as a buyer is willing to pay the current price.
- **User Simplicity:** The process is straightforward: call `buy()` and receive the asset instantly. There is no need to return to claim.
- **Predictability:** The price path is deterministic, making it easier to program liquidator bots.

## 4. Code Impact

- **`LiquidationManager.sol`:** Completely refactored.
    - The `Auction` struct was simplified.
    - The `liquidate()` function was renamed to `startAuction()`.
    - The `bid()` function was removed and replaced by `buy()`.
    - The need for a `claimAuction()` function was eliminated.
- **`DEVELOPMENT_PLAN.md`:** The task of implementing `claim` became obsolete and was effectively merged into the new `buy` logic.

---

## 5. Critical Issue: Liquidation Funds Trapped in the Contract

**Status:** Fixed

-   **Contract:** `LiquidationManager.sol`
-   **Problem Description:** The `buy` function transfers the `SCC-USD` paid by the buyer to the `LiquidationManager` contract. However, the contract has no function that allows governance (the `owner`, which is the `TimelockController`) to withdraw these accumulated funds.
-   **Impact:** **High.** All revenue generated by liquidations (the debt paid by liquidators) will be permanently trapped in the `LiquidationManager` contract address. These funds cannot be moved to the `StakingPool` as rewards or used for any other protocol purpose.
-   **Required Action (Fix):**
    1.  Add a new function to `LiquidationManager.sol`, such as `withdrawFees(address recipient, uint256 amount) external onlyOwner`.
    2.  This function should allow the `owner` (governance) to specify a destination address and an amount of `SCC-USD` to be withdrawn from the contract's balance.
    3.  Ensure that the `TimelockController` has the ability to call this function to manage the protocol's revenues.