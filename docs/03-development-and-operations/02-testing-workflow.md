# 2. SCC Protocol Testing Workflow

This document provides an overview of the existing test suite for the smart contracts and off-chain services of the SCC protocol, as well as recommendations for future tests to increase the system's robustness and security.

## 2.1. Smart Contract Tests (Foundry)

The smart contract test suite is implemented with the Foundry framework, focusing on unit and integration tests to validate the business logic and security rules of each protocol component.

### 2.1.1. Test Coverage by Contract

The tests cover the following contracts and functionalities:

*   **Token Contracts (`SCC_USD` and `SCC_GOV`):**
    *   Verification of deployment with the correct name and symbol.
    *   `SCC_USD`: Confirms that only accounts with `MINTER_ROLE` can create new tokens and that burning tokens from other accounts (`burnFrom`) requires prior approval.
    *   `SCC_GOV`: Ensures that the initial supply is correctly sent to the deployer.
*   **`OracleManager.sol`:**
    *   **Security and Access:** Only authorized addresses can query prices.
    *   **Data Validation:** Reverts transactions for outdated, invalid (zero or negative) prices, or when no price feed is configured.
    *   **Administration:** Only governance can add or update price feeds.
*   **`Vault.sol` and `VaultFactory.sol`:**
    *   **Vault Creation:** `VaultFactory` ensures that new `Vaults` are created successfully, NFT ownership is assigned correctly, and essential permissions (Oracle, `SCC_USD` Mint) are delegated.
    *   **Position Management (CDP):** Tests for collateral deposit/withdrawal and `SCC-USD` debt creation/repayment.
    *   **Vault Security:** Validates that the user cannot withdraw collateral or create debt if it violates the minimum collateralization ratio.
    *   **Access Control:** Only the `LiquidationManager` can invoke internal functions for collateral transfer during liquidation.
*   **`LiquidationManager.sol`:**
    *   **Auction Start:** Verifies that an auction can only be started for an under-collateralized `Vault` with no active auction.
    *   **Dutch Auction Logic:** `test_getCurrentPrice_DecaysLinearly` confirms the linear price decay. `buy()` tests cover partial and full purchase scenarios, validating the update of the auction and `Vault` state.
    *   **Bug Fixes:** Specific tests (`test_buy_MultiplePartialPurchases_VaultStateUpdated`, `test_buy_DebtDustHandling`) validate correct accounting and rounding treatment.
*   **`StakingPool.sol` and Governance:**
    *   **Staking Cycle:** Tests for deposit (`stake`), withdrawal (`unstake`), and reward redemption (`getReward`).
    *   **Reward Calculation:** Validates that `SCC-USD` rewards are calculated and distributed proportionally.
    *   **Governance:** Tests for `StakingPoolGovernance` and `SCC_Governor` ensure the administration of contracts and the lifecycle of a governance proposal (proposal -> vote -> queue -> execution).

### 2.1.2. Test Directory Structure (`contracts/test/`)

The `contracts/test/` directory contains `.t.sol` test files for each main contract component, such as:

*   `FeeLifecycle.t.sol`
*   `LiquidationManager.t.sol`
*   `OracleManager.t.sol`
*   `SCC_Governor.t.sol`
*   `SCC_Parameters.t.sol`
*   `StakingPool.t.sol`
*   `StakingPoolGovernance.t.sol`
*   `Vault.t.sol`
*   `VaultFactory.t.sol`
*   `VaultSecurity.t.sol`
*   `tokens/` (for token tests like `SCC_USD` and `SCC_GOV`)

## 2.2. Off-chain Services Tests (Jest)

Off-chain services (like the Keeper Bot) are tested using Jest, with a focus on integration tests to ensure correct interaction with the blockchain.

### 2.2.1. Test Directory Structure (`offchain/test/`)

The `offchain/test/` directory contains:

*   **`integration/`:** Contains integration tests that verify the behavior of off-chain services in conjunction with a local blockchain. Example: `liquidation.test.ts` tests the full liquidation flow.

## 2.3. Code Analysis and Metrics

*   **Static Analysis:** Tools like Slither are integrated into the CI/CD process to detect known vulnerability patterns.
*   **Code Coverage:** A test coverage target of over 95% is maintained, with reports generated by `forge coverage`.

## 2.4. Recommendations for Future Tests

To increase the protocol's robustness to a production level, the following tests are recommended, focusing on edge cases, security, and complex integration:

1.  **Re-entrancy Test in `Vault.sol`:** Simulate a re-entrancy attack to prove the contract's immunity.
2.  **Full Revenue Flow Test (End-to-End):** Simulate the entire protocol revenue lifecycle, from liquidation to reward distribution via staking and governance.
3.  **Exact Limit Test in `LiquidationManager.sol`:** Force an auction where the collateral purchase results in a remaining debt *exactly* equal to `DEBT_DUST` to ensure the correct closing of the auction.
4.  **Governance Attack Test in `OracleManager.sol`:** Simulate a malicious governance proposal to swap a valid price feed for a fake one, documenting the impact and verifying the protocol's defenses.
