# Deploy and Execution Guide (Local with Docker)

**Status:** Active

## 1. Overview

This guide describes how to run the complete development and testing environment for the `offchain` bot using Docker Compose. The environment is fully self-contained and includes the local blockchain (Anvil), the bot (Keeper), and a monitoring server (Prometheus).

## 2. Prerequisites

-   [Docker](https://www.docker.com/get-started/)
-   [Docker Compose](https://docs.docker.com/compose/install/)

## 3. Configuration

The `offchain` bot relies on an `.env` file to get contract addresses and other configurations. This file is automatically generated from the result of a successful deployment.

The workflow to configure the local environment is:

1.  **Deploy the Contracts:** First, deploy the contracts at the project root. This creates a file with the addresses of the new deployment.
    ```bash
    # At the project root
    pnpm deploy:contracts
    ```

2.  **Prepare the Off-chain Environment:** Next, run the new `prepare:env` script to populate the `offchain/.env` file with the newly deployed addresses.
    ```bash
    # At the project root
    pnpm --filter=@scc/offchain prepare:env
    ```

After these steps, the bot will be configured and ready to run with the correct addresses.

## 4. Running the Environment

With Docker running, navigate to the project root and execute the following command:

```bash
docker-compose up --build
```

-   `--build`: Forces the rebuilding of the bot's image if there are code changes.

This command will:
1.  Build the Docker image for the `keeper` service.
2.  Start the three services: `anvil`, `keeper`, and `prometheus`.
3.  Display the logs of all services in your terminal.

## 5. Verifying the Services

After initialization, you can check if each service is running:

-   **Keeper Bot:** In the `docker-compose` logs, you will see bot messages, such as "TransactionManager initialized..." and "Watching for new vaults...".

-   **Metrics (Prometheus Endpoint):** Open your browser and go to [http://localhost:9091/metrics](http://localhost:9091/metrics). You will see a long list of metrics exposed by the bot, such as `keeper_eth_balance` and `keeper_vaults_discovered_total`.

-   **Prometheus Server:** Open your browser and go to [http://localhost:9090](http://localhost:9090). This is the Prometheus dashboard. To check if it is collecting data from the bot, go to `Status -> Targets`. You should see the `keeper-bot` endpoint with the state "UP".

## 6. Viewing the Logs

If you started the environment in "detached" mode (`-d`), you can view the logs of a specific service at any time.

```bash
# View bot logs
docker-compose logs -f keeper

# View local blockchain logs
docker-compose logs -f anvil
```

## 7. Stopping the Environment

To stop all services and remove the containers, press `Ctrl+C` in the terminal where `docker-compose` is running, or execute the following command in a new terminal (from the project root):

```bash
docker-compose down
```